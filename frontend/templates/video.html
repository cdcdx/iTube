{% extends "base.html" %}
{% block content %}

<div class="video-container">
    <div id="aspectratio-data" style="display:none;">{{ results.videos.aspectratio | tojson }}</div>
    <!-- Video Player -->
    <div id="player-wrapper" class="player-wrapper">
        <!-- Video.js Player -->
        <div id="player-wrapper-videojs" class="player-wrapper-player" style="display: none;">
            <div id="player-videojs" class="player-container" 
                title="{{ results.videos.code + ': ' if results.videos.code else '' }}{{ results.videos.size }} MB">
                <video id="video-videojs" class="video-js vjs-default-skin player-video-container" style="width: 100%; height: 100%;" controls preload="auto" data-setup="{}">
                    <source src="{{ url_for('stream_and_convert_video', id_name=id, base_name=base) }}" type="video/mp4" />
                    Your browser does not support video playback.
                </video>
            </div>
        </div>

        <!-- MediaElement Player -->
        <div id="player-wrapper-mediaelement" class="player-wrapper-player" style="display: none;">
            <div id="player-mediaelement" class="player-container" 
                title="{{ results.videos.code + ': ' if results.videos.code else '' }}{{ results.videos.size }} MB">
                <video id="video-mediaelement" class="player-video-container" style="width: 100%; height: 100%;" controls preload="auto">
                    <source src="{{ url_for('stream_and_convert_video', id_name=id, base_name=base) }}" type="video/mp4" />
                    Your browser does not support video playback.
                </video>
            </div>
        </div>

        <!-- Plyr HLS Player -->
        <div id="player-wrapper-plyr" class="player-wrapper-player" style="display: none;">
            <div id="player-plyr" class="player-container" 
                title="{{ results.videos.code + ': ' if results.videos.code else '' }}{{ results.videos.size }} MB">
                <video id="video-plyr" class="player-video-container player-plyr" style="width: 100%; height: 100%;" controls crossorigin playsinline>
                    <source src="{{ url_for('stream_and_convert_video', id_name=id, base_name=base) }}" type="video/mp4" />
                    Your browser does not support video playback.
                </video>
            </div>
        </div>
    </div>

    <!-- Title / Star / Button -->
    <div id="videotitle" class="video-info-container" style="margin: auto; display: flex; justify-content: space-between; margin-top: 10px;" tabindex="0">
        <div style="flex: 1; max-width: calc(100% - 102px); width: auto;">
            <textarea class="textarea-control" id="videoDescription" style="width: 100%; margin: auto; border: none;" readonly>{{ results.videos.file }}</textarea>
        </div>
        <div class="video-controls-container">
            <!-- Stars -->
            <div class="rating-container" style="width: 90px;">
                <span class="rating-stars" id="rating-stars-{{ results.videos.id }}" data-video-id="{{ results.videos.id }}" data-score="{{ results.videos.score }}" title="Rate">
                    {% if results.videos.score %}
                        {% for i in range(1, 6) %}
                            {% if i <= results.videos.score %} 
                                <i class="fas fa-star text-warning star-icon" data-value="{{ i }}"></i>
                            {% elif i == (results.videos.score + 0.5)|int and results.videos.score % 1 != 0 %}
                                <i class="fas fa-star-half-alt text-warning star-icon" data-value="{{ i }}"></i>
                            {% else %}
                                <i class="far fa-star text-warning star-icon" data-value="{{ i }}"></i>
                            {% endif %}
                        {% endfor %}
                    {% else %}
                        {% for i in range(1, 6) %}
                            <i class="far fa-star text-warning star-icon" data-value="{{ i }}"></i>
                        {% endfor %}
                    {% endif %}
                </span>
            </div>
            <!-- Control -->
            <div style="display: flex; flex-wrap: wrap; gap: 2px;">
                <button class="btn btn-danger ms-auto control-btn" type="button" style="width: 30px; height: 30px;"
                    onclick="onFileDelete('{{ id }}')" title="Delete">
                    <i class="fas fa-trash"></i>
                </button>
                <button class="btn btn-danger ms-auto control-btn" type="button" style="width: 30px; height: 30px;"
                    onclick="onFileCut('{{ id }}')" title="Cut">
                    <i class="fas fa-cut"></i>
                </button>
                <button class="btn btn-danger ms-auto control-btn" type="button" style="width: 30px; height: 30px;"
                    onclick="onFileTranscode('{{ id }}')" title="Transcode">
                    <i class="fas fa-code"></i>
                </button>
                <button class="btn btn-danger ms-auto control-btn" type="button" style="width: 30px; height: 30px;"
                    onclick="onModalRename('{{ id }}', '{{ results.videos.base }}')" title="Rename">
                    <i class="fas fa-pen"></i>
                </button>
                <button class="btn btn-danger ms-auto control-btn" type="button" style="width: 30px; height: 30px;"
                    onclick="onFileWebname('{{ id }}')" title="SyncData">
                    <i class="fas fa-sync"></i>
                </button>
                <button class="btn btn-danger ms-auto control-btn" type="button" style="width: 30px; height: 30px;"
                    onclick="onFileWebLink('{{ results.videos.code }}')" title="Link">
                    <i class="fas fa-unlink"></i>
                </button>
            </div>
        </div>
        <!-- Switch -->
        <div style="width: 60px; height: 80px; margin-bottom: 2px;">
            <button class="btn btn-success ms-auto control-btn" type="button" style="width: 100%; height: 100%;"
                onclick="togglePlayer()" title="Switch">
                <i class="fas fa-exchange-alt"></i>
            </button>
        </div>
    </div>

    <!-- Pagination -->
    <div id="page-data" data-current-page="{{ id | default(1) }}" data-total-count="{{ results.count | default(0) }}" style="display: none;"></div>
    <div class="pagination-container">
        <div class="pagination-wrapper">
            <a href="#" class="btn btn-danger ms-auto control-btn" id="btnone"><i class="fas fa-angle-double-left"></i></a>
            <a href="#" class="btn btn-danger ms-auto control-btn" id="btntwo"><i class="fas fa-angle-left"></i></a>
            <a href="#" class="btn btn-danger ms-auto control-btn" id="btnthree"></a>
            <a href="#" class="btn btn-danger ms-auto control-btn" id="btnfour"><i class="fas fa-angle-right"></i></a>
            <a href="#" class="btn btn-danger ms-auto control-btn" id="btnfive"><i class="fas fa-angle-double-right"></i></a>
        </div>
    </div>

    <!-- Custom JavaScript -->
    <script>
        // 更新评分显示
        function updateRatingDisplay(videoId, newScore) {
            const ratingElement = document.getElementById(`rating-stars-${videoId}`);
            if (ratingElement) {
                let starsHtml = '';

                for (let i = 1; i <= 5; i++) {
                    if (i <= Math.floor(newScore)) {
                        // 完整星
                        starsHtml += `<i class="fas fa-star text-warning star-icon" data-value="${i}"></i>`;
                    } else if (i == Math.ceil(newScore) && newScore % 1 >= 0.5) {
                        // 半星
                        starsHtml += `<i class="fas fa-star-half-alt text-warning star-icon" data-value="${i}"></i>`;
                    } else {
                        // 空星
                        starsHtml += `<i class="far fa-star text-warning star-icon" data-value="${i}"></i>`;
                    }
                }

                ratingElement.innerHTML = starsHtml;
                ratingElement.setAttribute('data-score', newScore);
            }
        }

        // 评分处理
        document.addEventListener('click', function (e) {
            if (e.target.classList.contains('star-icon')) {
                const ratingSpan = e.target.closest('.rating-stars');
                if (ratingSpan) {
                    const videoId = ratingSpan.dataset.videoId;
                    const starValue = parseInt(e.target.dataset.value);

                    // 提交评分
                    onFileScore(videoId, starValue);
                }
            }
        });

        // 重命名逻辑
        let currentName = 0;

        // 打开重命名窗口
        function onModalRename(id, oldbasename) {
            const oldbaseBytes = Base58.decode(oldbasename);
            const oldname = new TextDecoder().decode(oldbaseBytes);
            currentName = oldname;

            // 拆分文件路径、文件名和扩展名
            const lastSlashIndex = oldname.lastIndexOf('/');
            let filePath = '';
            let fileNameWithExt = oldname;

            if (lastSlashIndex !== -1) {
                filePath = oldname.substring(0, lastSlashIndex);
                fileNameWithExt = oldname.substring(lastSlashIndex + 1);
            }

            // 分离文件名和扩展名
            const lastDotIndex = fileNameWithExt.lastIndexOf('.');
            let fileName = fileNameWithExt;
            let fileExt = '';

            if (lastDotIndex !== -1) {
                fileName = fileNameWithExt.substring(0, lastDotIndex);
                fileExt = fileNameWithExt.substring(lastDotIndex);
            }

            // 设置模态窗口中的输入框初始值
            document.getElementById('newFilePath').value = filePath;
            document.getElementById('newFilePath').classList.remove('is-invalid');
            document.getElementById('newFileName').value = fileName;
            document.getElementById('newFileName').classList.remove('is-invalid');
            document.getElementById('newFileExt').value = fileExt;
            document.getElementById('newFileExt').classList.remove('is-invalid');

            // 显示模态窗口
            const renameModal = new bootstrap.Modal(document.getElementById('customRenameModal'));
            renameModal.show();
        }

        // 重命名提交
        function submitRename() {
            onFileRename('{{ id }}', currentName);
            const modalInstance = bootstrap.Modal.getInstance(document.getElementById('customRenameModal'));
            if (modalInstance) {
                modalInstance.hide();
            }
        }

        // debounce
        function debounce(func, wait) {
            let timeout;
            return function executedFunction(...args) {
                const later = () => {
                    clearTimeout(timeout);
                    func(...args);
                };
                clearTimeout(timeout);
                timeout = setTimeout(later, wait);
            };
        }

        // Reset size and dimensions
        function resetSize() {
            const aspectratio = JSON.parse(document.getElementById('aspectratio-data').textContent) || 0.5625;
            const x = document.body.clientWidth - 20;
            const y = document.body.clientHeight - 160;
            const xheight = Math.ceil(x * aspectratio);
            const ywidth = Math.ceil(y / aspectratio);

            let width, height;
            if (xheight <= y) {
                width = x;
                height = xheight;
            } else {
                width = ywidth;
                height = y;
            }

            // Set wrapper dimensions
            const playerWrapper = document.getElementById('player-wrapper');
            if (playerWrapper) {
                playerWrapper.style.width = width + "px";
                playerWrapper.style.height = height + "px";
            }

            // Set individual player dimensions
            const players = ['player-plyr', 'player-videojs', 'player-mediaelement'];
            players.forEach(playerId => {
                const player = document.getElementById(playerId);
                if (player) {
                    player.style.width = width + "px";
                    player.style.height = height + "px";
                }
            });

            const videoTitle = document.getElementById('videotitle');
            if (videoTitle) {
                videoTitle.style.width = width + "px";
                videoTitle.style.height = "82px";
            }
        }

        // Set button links
        function setButtonLinks(currentPage, totalPages) {
            const buttons = ['btnone', 'btntwo', 'btnthree', 'btnfour', 'btnfive'];
            buttons.forEach((id, index) => {
                const btn = document.getElementById(id);
                if (btn) {
                    const page = currentPage + index - 2;
                    if (page >= 1 && page <= totalPages) {
                        btn.href = `/video/${page}`;
                        btn.hidden = false;
                    } else {
                        btn.hidden = true;
                    }
                }
            });
            const btnThree = document.getElementById('btnthree');
            if (btnThree) {
                btnThree.textContent = `${currentPage}`;
            }
        }

        // Get parameters
        const pageDataElement = document.getElementById('page-data');
        const totalPages = parseInt(pageDataElement.dataset.totalCount || '0');
        const currentPage = parseInt(pageDataElement.dataset.currentPage || '1');
        // Set button links
        setButtonLinks(currentPage, totalPages);

        // Reset size and dimensions
        resetSize();
        const debouncedResize = debounce(resetSize, 250);
        window.addEventListener('resize', debouncedResize);

        // Hidden button
        document.getElementById('btnclear').hidden = true;
        document.getElementById('btnshow').hidden = true;
        document.getElementById('btnsyncMenu').hidden = true;
        document.getElementById('btnscanMenu').hidden = true;
    </script>

    <!-- Player JavaScript -->
    <script>
        let plyrPlayer, videojsPlayer, mediaelementPlayer;
        let currentPlayer = getLocalStorage('Player', 'plyr');

        // 初始化播放器
        function initializePlayers() {
            // 隐藏所有播放器
            const plyrWrapper = document.getElementById('player-wrapper-plyr');
            const videojsWrapper = document.getElementById('player-wrapper-videojs');
            const mediaelementWrapper = document.getElementById('player-wrapper-mediaelement');
            if (plyrWrapper) plyrWrapper.style.display = 'none';
            if (videojsWrapper) videojsWrapper.style.display = 'none';
            if (mediaelementWrapper) mediaelementWrapper.style.display = 'none';

            // 根据配置初始化播放器
            if (currentPlayer === 'plyr') {
                initPlyrPlayer();
            } else if (currentPlayer === 'videojs') {
                initVideoJSPlayer();
            } else {
                initMediaElementPlayer();
            }

            // 切换播放器
            switchPlayer(currentPlayer, false);
        }

        // 初始化MediaElement播放器
        function initMediaElementPlayer() {
            // 如果已经初始化则返回
            if (mediaelementPlayer) return;

            const videoElement = document.getElementById('video-mediaelement');
            if (!videoElement) return;

            // 检查mediaelement是否已经在初始化过程中或者已经存在实例
            if (videoElement.player) {
                mediaelementPlayer = videoElement.player;
                return;
            }

            // 初始化mediaelement
            mediaelementPlayer = new MediaElementPlayer(videoElement, {
                features: [
                    'playpause',
                    'current',
                    'progress',
                    'duration',
                    'volume',
                    'fullscreen'
                ],
                success: function (mediaElement, originalNode) {
                    console.log('mediaelement player initialized');
                },
                error: function (mediaElement, error) {
                    console.log('mediaelement error:', error);
                }
            });

            // Listen to focus event
            document.addEventListener('focusin', function (event) {
                const playerContainer = document.getElementById('player-mediaelement');
                if (playerContainer && playerContainer.contains(event.target)) {
                    const titleElement = document.getElementById('videotitle');
                    if (titleElement) {
                        titleElement.focus();
                    }
                }
            });
        }

        // 初始化Video.js播放器
        function initVideoJSPlayer() {
            // 如果已经初始化则返回
            if (videojsPlayer) return;

            const videoElement = document.getElementById('video-videojs');
            if (!videoElement) return;

            // 检查videojs是否已经在初始化过程中或者已经存在实例
            if (videoElement.player) {
                videojsPlayer = videoElement.player;
                return;
            }

            // 添加加载指示器
            const container = document.getElementById('player-videojs');
            const loader = document.createElement('div');
            loader.className = 'player-loader';
            loader.innerHTML = '<div class="spinner-border text-light" role="status"><span class="visually-hidden">Loading...</span></div>';
            container.appendChild(loader);

            // 初始化Video.js
            videojsPlayer = videojs('video-videojs', {
                fluid: true,
                responsive: true,
                fill: true,
                controls: true,
                autoplay: false,
                preload: 'metadata',
                playbackRates: [0.5, 0.75, 1, 1.25, 1.5, 2],
                controlBar: {
                    children: [
                        'playToggle',
                        'volumePanel',
                        'currentTimeDisplay',
                        'timeDivider',
                        'durationDisplay',
                        'progressControl',
                        'playbackRateMenuButton',
                        'fullscreenToggle'
                    ]
                }
            });

            // 播放器准备就绪后移除加载指示器
            videojsPlayer.ready(function () {
                if (loader.parentNode) {
                    loader.parentNode.removeChild(loader);
                }
                console.log('videojs player initialized');
            });
        }

        // 初始化Plyr播放器
        function initPlyrPlayer() {
            // 如果已经初始化则返回
            if (plyrPlayer) return;

            const videoElement = document.getElementById('video-plyr');
            if (!videoElement) return;

            // 初始化Plyr
            plyrPlayer = new Plyr('#video-plyr', {
                controls: [
                    'play-large',
                    'play',
                    'progress',
                    'current-time',
                    'mute',
                    'volume',
                    'captions',
                    'settings',
                    'pip',
                    'airplay',
                    'download',
                    'fullscreen'
                ],
                i18n: {
                    restart: '重新开始',
                    rewind: '倒带 {seektime}s',
                    play: '播放',
                    pause: '暂停',
                    fastForward: '快进 {seektime}s',
                    seek: 'Seek',
                    played: 'Played',
                    buffered: 'Buffered',
                    currentTime: 'Current time',
                    duration: 'Duration',
                    volume: 'Volume',
                    mute: '静音',
                    unmute: '取消静音',
                    enableCaptions: '开启字幕',
                    disableCaptions: '关闭字幕',
                    download: '下载',
                    enterFullscreen: '进入全屏',
                    exitFullscreen: '退出全屏',
                    frameTitle: 'Player for {title}',
                    captions: '字幕',
                    settings: '设置',
                    speed: '速度',
                    quality: '质量',
                    loop: '循环',
                    start: '开始',
                    end: '结束',
                    all: '全部',
                    reset: '重置',
                    disabled: '禁用',
                    advertisement: '广告',
                    qualityBadge: {
                        2160: '4K',
                        1440: 'HD',
                        1080: 'HD',
                        720: 'HD',
                        576: 'SD',
                        480: 'SD',
                    },
                },
            });

            // 如果源是HLS格式，使用HLS.js
            const source = videoElement.querySelector('source');
            if (source && (source.type === 'application/x-mpegURL' || source.src.includes('.m3u8'))) {
                if (Hls.isSupported()) {
                    const hls = new Hls();
                    hls.loadSource(source.src);
                    hls.attachMedia(videoElement);
                    
                    // Listen to HLS event
                    hls.on(Hls.Events.MANIFEST_PARSED, function() {
                        console.log('HLS manifest parsed');
                        videoElement.play().catch(error => console.log('Play after HLS init failed:', error));
                    });
                } else if (videoElement.canPlayType('application/vnd.apple.mpegurl')) {
                    // Safari native HLS support
                    videoElement.src = source.src;
                    videoElement.addEventListener('loadedmetadata', function() {
                        console.log('Safari HLS loaded');
                        videoElement.play().catch(error => console.log('Play after HLS init failed:', error));
                    });
                }
            }

            console.log('plyr player initialized');
        }

        // 播放器切换函数
        function switchPlayer(targetPlayer, shouldSyncState = true) {
            let syncData = null;

            // 仅在需要同步状态时获取当前播放状态
            if (shouldSyncState) {
                if (currentPlayer === 'plyr' && plyrPlayer) {
                    // 获取当前播放器状态
                    syncData = {
                        currentTime: plyrPlayer.currentTime || 0,
                        volume: plyrPlayer.volume || 1,
                        paused: plyrPlayer.paused
                    };

                    // 暂停当前播放器
                    plyrPlayer.pause();
                } else if (currentPlayer === 'videojs' && videojsPlayer) {
                    // 获取当前播放器状态
                    syncData = {
                        currentTime: videojsPlayer.currentTime() || 0,
                        volume: videojsPlayer.volume() || 1,
                        paused: videojsPlayer.paused()
                    };

                    // 暂停当前播放器
                    videojsPlayer.pause();
                } else if (currentPlayer === 'mediaelement' && mediaelementPlayer) {
                    // 获取当前播放器状态
                    syncData = {
                        currentTime: mediaelementPlayer.media.currentTime || 0,
                        volume: mediaelementPlayer.media.volume || 1,
                        paused: mediaelementPlayer.media.paused
                    };

                    // 暂停当前播放器
                    mediaelementPlayer.media.pause();
                }
            }

            // 隐藏所有播放器
            const plyrWrapper = document.getElementById('player-wrapper-plyr');
            const videojsWrapper = document.getElementById('player-wrapper-videojs');
            const mediaelementWrapper = document.getElementById('player-wrapper-mediaelement');
            if (plyrWrapper) plyrWrapper.style.display = 'none';
            if (videojsWrapper) videojsWrapper.style.display = 'none';
            if (mediaelementWrapper) mediaelementWrapper.style.display = 'none';

            if (targetPlayer === 'plyr') {
                // 显示Plyr
                if (plyrWrapper) {
                    plyrWrapper.style.display = 'block';

                    // 确保Plyr播放器已初始化
                    if (!plyrPlayer) {
                        initPlyrPlayer();
                    }

                    // 状态同步
                    if (syncData && plyrPlayer) {
                        // 等待Plyr准备就绪
                        plyrPlayer.currentTime = syncData.currentTime;
                        plyrPlayer.volume = syncData.volume;

                        // 如果原播放器不是暂停的，则开始播放
                        if (!syncData.paused) {
                            plyrPlayer.play().catch(error => console.log('Play after switch failed:', error));
                        }
                    }
                }
            } else if (targetPlayer === 'videojs') {
                // 显示Video.js
                if (videojsWrapper) {
                    videojsWrapper.style.display = 'block';

                    // 确保Video.js播放器已初始化
                    if (!videojsPlayer) {
                        initVideoJSPlayer();
                    }

                    // 状态同步
                    if (syncData) {
                        // 等待播放器就绪后同步状态
                        if (videojsPlayer) {
                            videojsPlayer.ready(() => {
                                videojsPlayer.currentTime(syncData.currentTime);
                                videojsPlayer.volume(syncData.volume);

                                // 如果原播放器不是暂停的，则开始播放
                                if (!syncData.paused) {
                                    videojsPlayer.play().catch(error => console.log('Play after switch failed:', error));
                                }
                            });
                        }
                    }
                }
            } else {
                // 显示MediaElement
                if (mediaelementWrapper) {
                    mediaelementWrapper.style.display = 'block';

                    // 确保MediaElement播放器已初始化
                    if (!mediaelementPlayer) {
                        initMediaElementPlayer();
                    }

                    // 状态同步
                    if (syncData && mediaelementPlayer && mediaelementPlayer.media) {
                        // 等待MediaElement准备就绪
                        mediaelementPlayer.media.currentTime = syncData.currentTime;
                        mediaelementPlayer.media.volume = syncData.volume;

                        // 如果原播放器不是暂停的，则开始播放
                        if (!syncData.paused) {
                            mediaelementPlayer.media.play();
                        }
                    }
                }
            }

            // 更新当前播放器标识
            currentPlayer = targetPlayer;
        }

        // 切换播放器
        function togglePlayer() {
            let newPlayer;
            if (currentPlayer === 'plyr') {
                newPlayer = 'videojs';
            } else if (currentPlayer === 'videojs') {
                newPlayer = 'mediaelement';
            } else if (currentPlayer === 'mediaelement') {
                newPlayer = 'plyr';
            }
            switchPlayer(newPlayer, true);

            // 保存用户首选的播放器
            updateLocalStorage('Player', newPlayer);
        }

        // 键盘控制函数
        function setupKeyboardControls() {
            document.addEventListener('keydown', function (event) {
                // 检查事件目标是否是输入元素
                const isInputElement =
                    event.target.tagName === 'INPUT' ||
                    event.target.tagName === 'TEXTAREA' ||
                    event.target.contentEditable === 'true' ||
                    event.target.isContentEditable;

                // 如果焦点在输入元素上，直接返回，不执行播放器控制
                if (isInputElement) {
                    return;
                }

                // 快捷键切换播放器 (P key)
                if (event.key === 'p' || event.key === 'P') {
                    togglePlayer();
                    event.preventDefault();
                    return;
                }

                // 获取当前活动的播放器
                let activePlayer = getActivePlayer();
                if (!activePlayer) return;

                // 根据当前播放器类型执行相应的控制操作
                switch (event.key) {
                    case 'ArrowRight': // 快进 10s
                        skipTime(activePlayer, currentPlayer, 10);
                        event.preventDefault();
                        break;
                    case 'ArrowLeft': // 快退 10s
                        skipTime(activePlayer, currentPlayer, -10);
                        event.preventDefault();
                        break;
                    case 'ArrowUp': // 增加音量 10%
                        adjustVolume(activePlayer, currentPlayer, 0.1);
                        event.preventDefault();
                        break;
                    case 'ArrowDown': // 减少音量 10%
                        adjustVolume(activePlayer, currentPlayer, -0.1);
                        event.preventDefault();
                        break;
                    case ' ': // Play/Pause
                        togglePlayback(activePlayer, currentPlayer);
                        event.preventDefault();
                        break;
                    case 'm': // Mute
                    case 'M':
                        toggleMute(activePlayer, currentPlayer);
                        event.preventDefault();
                        break;
                    case 'f': // Fullscreen
                    case 'F':
                        toggleFullscreen(activePlayer, currentPlayer);
                        event.preventDefault();
                        break;
                    default:
                        return;
                }
            });
        }

        // 获取当前活跃的播放器
        function getActivePlayer() {
            if (currentPlayer === 'plyr' && plyrPlayer) {
                return plyrPlayer;
            } else if (currentPlayer === 'videojs' && videojsPlayer) {
                return videojsPlayer;
            } else if (currentPlayer === 'mediaelement' && mediaelementPlayer && mediaelementPlayer.media) {
                return mediaelementPlayer.media;
            }
            return null;
        }

        // 跳转时间函数
        function skipTime(player, playerType, seconds) {
            if (playerType === 'plyr') {
                // Plyr Player
                if (player.duration) {
                    const newTime = Math.max(0, Math.min(player.duration, player.currentTime + seconds));
                    player.currentTime = newTime;
                }
            } else if (playerType === 'videojs') {
                // Video.js Player
                if (player.duration()) {
                    const newTime = Math.max(0, Math.min(player.duration(), player.currentTime() + seconds));
                    player.currentTime(newTime);
                }
            } else if (playerType === 'mediaelement') {
                // MediaElement Player
                if (player.duration) {
                    const newTime = Math.max(0, Math.min(player.duration, player.currentTime + seconds));
                    player.currentTime = newTime;
                }
            }
        }

        // 调整音量函数
        function adjustVolume(player, playerType, delta) {
            if (playerType === 'plyr') {
                // Plyr Player
                const newVolume = Math.max(0, Math.min(1, player.volume + delta));
                player.volume = newVolume;
            } else if (playerType === 'videojs') {
                // Video.js Player
                const newVolume = Math.max(0, Math.min(1, player.volume() + delta));
                player.volume(newVolume);
            } else if (playerType === 'mediaelement') {
                // MediaElement Player
                const newVolume = Math.max(0, Math.min(1, player.volume + delta));
                player.volume = newVolume;
            }
        }

        // 播放/暂停切换函数
        function togglePlayback(player, playerType) {
            if (playerType === 'plyr') {
                // Plyr Player
                if (player.paused) {
                    player.play().catch(error => console.error('Play failed:', error));
                } else {
                    player.pause();
                }
            } else if (playerType === 'videojs') {
                // Video.js Player
                if (player.paused()) {
                    player.play().catch(error => console.error('Play failed:', error));
                } else {
                    player.pause();
                }
            } else if (playerType === 'mediaelement') {
                // MediaElement Player
                if (player.paused) {
                    player.play();
                } else {
                    player.pause();
                }
            }
        }

        // 静音切换函数
        function toggleMute(player, playerType) {
            if (playerType === 'plyr') {
                // Plyr Player
                player.muted = !player.muted;
            } else if (playerType === 'videojs') {
                // Video.js Player
                player.muted(!player.muted());
            } else if (playerType === 'mediaelement') {
                // MediaElement Player
                player.muted = !player.muted;
            }
        }

        // 全屏切换函数
        function toggleFullscreen(player, playerType) {
            if (playerType === 'plyr') {
                player.fullscreen.toggle();
            } else if (playerType === 'videojs') {
                player.requestFullscreen();
            } else if (playerType === 'mediaelement') {
                if (typeof player.enterFullScreen === 'function') {
                    player.enterFullScreen();
                } else if (typeof player.webkitEnterFullscreen === 'function') {
                    player.webkitEnterFullscreen();
                } else if (typeof player.msRequestFullscreen === 'function') {
                    player.msRequestFullscreen();
                } else {
                    // fallback to native fullscreen API
                    if (player.requestFullscreen) {
                        player.requestFullscreen();
                    } else if (player.webkitRequestFullscreen) {
                        player.webkitRequestFullscreen();
                    } else if (player.msRequestFullscreen) {
                        player.msRequestFullscreen();
                    }
                }
            }
        }

        // Page load initialization
        document.addEventListener('DOMContentLoaded', function () {
            // 初始化播放器
            initializePlayers();

            // 设置键盘控制
            setupKeyboardControls();
        });
    </script>
</div>

{% endblock %}